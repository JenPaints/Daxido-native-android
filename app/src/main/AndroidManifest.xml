<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- Permissions -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />

    <!-- SECURITY FIX: Background location permission with proper SDK restrictions
         This permission is required for:
         1. Real-time ride tracking for active rides
         2. Driver availability updates when app is in background
         3. Ensuring accurate ETA and navigation during rides

         Google Play requires clear justification for this permission.
         Users must explicitly grant this after foreground location permission.
         Only used during active rides, not for general location tracking.
    -->
    <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />

    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_CAMERA" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.CALL_PHONE" />

    <application
        android:name=".DaxidoApplication"
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.Daxido"
        android:enableOnBackInvokedCallback="true"
        tools:targetApi="34">

        <!-- Google Maps API Key - SECURITY: Now loaded from BuildConfig via manifestPlaceholders -->
        <meta-data
            android:name="com.google.android.geo.API_KEY"
            android:value="${MAPS_API_KEY}" />

        <!-- Firebase Messaging Service -->
        <service
            android:name=".core.services.DaxidoMessagingService"
            android:exported="false">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT" />
            </intent-filter>
        </service>

        <!-- Location Service -->
        <service
            android:name=".core.services.LocationTrackingService"
            android:foregroundServiceType="location"
            android:exported="false" />

        <!-- Emergency Camera Service for Live Dashcam -->
        <service
            android:name=".driver.services.EmergencyCameraService"
            android:foregroundServiceType="camera"
            android:exported="false" />

        <!-- Main Activity -->
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.Daxido.Splash"
            android:windowSoftInputMode="adjustResize"
            android:launchMode="singleTask">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

            <!-- DEEP LINK SUPPORT: Handle app deep links -->
            <!-- Format: daxido://ride/123 -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="daxido"
                    android:host="ride" />
                <data
                    android:scheme="daxido"
                    android:host="payment" />
                <data
                    android:scheme="daxido"
                    android:host="referral" />
                <data
                    android:scheme="daxido"
                    android:host="promo" />
            </intent-filter>

            <!-- HTTP/HTTPS Deep Links -->
            <!-- Format: https://daxido.com/ride/123 -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="https"
                    android:host="daxido.com"
                    android:pathPrefix="/ride" />
                <data
                    android:scheme="https"
                    android:host="daxido.com"
                    android:pathPrefix="/payment" />
                <data
                    android:scheme="https"
                    android:host="daxido.com"
                    android:pathPrefix="/referral" />
                <data
                    android:scheme="https"
                    android:host="www.daxido.com"
                    android:pathPrefix="/ride" />
            </intent-filter>
        </activity>

        <!-- File Provider for image capture -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>

    </application>

</manifest>